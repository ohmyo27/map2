<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ë¡œì¼€ì´ì…˜ ë§µ (ìµœì¢…ì™„ì„±)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* ì „ì²´ ë ˆì´ì•„ì›ƒ ì„¤ì • */
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; display: flex; }
        
        /* 1. ì™¼ìª½ ì‚¬ì´ë“œë°” (PCìš© ë¦¬ìŠ¤íŠ¸) */
        .sidebar {
            width: 320px; height: 100vh; background: white; border-right: 1px solid #ddd;
            overflow-y: auto; z-index: 2000; display: flex; flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; background: #f8f9fa; }
        .sidebar-header h2 { margin: 0; font-size: 18px; color: #333; font-weight: 700; }
        
        .location-item {
            padding: 15px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; gap: 12px; align-items: start; transition: 0.2s;
        }
        .location-item:hover { background: #f1f8ff; }
        
        /* ë¦¬ìŠ¤íŠ¸ ì¸ë„¤ì¼ ë°•ìŠ¤ */
        .thumb-box {
            width: 70px; height: 70px; border-radius: 8px; background: #eee; overflow: hidden; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 10px;
        }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .info-box { flex: 1; }
        .info-box h3 { margin: 0 0 5px 0; font-size: 16px; color: #333; }
        .info-box p { margin: 0; font-size: 13px; color: #666; line-height: 1.4; }
        .genre-tag { display: inline-block; padding: 3px 6px; border-radius: 4px; font-size: 11px; color: white; margin-bottom: 4px; font-weight: bold; }

        /* ëª¨ë°”ì¼ì—ì„œëŠ” ì‚¬ì´ë“œë°” ìˆ¨ê¸°ê¸° */
        @media (max-width: 768px) { .sidebar { display: none; } }

        /* 2. ì§€ë„ ì˜ì—­ */
        #map { flex: 1; height: 100vh; z-index: 1; position: relative; }
        
        /* í•€ ëˆŒë €ì„ ë•Œ ë‚˜ì˜¤ëŠ” íŒì—… ì´ë¯¸ì§€ */
        .popup-img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 8px; cursor: pointer; display: block; }

        /* ìƒë‹¨ ê²€ìƒ‰ì°½ */
        .search-wrapper { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 3000; }
        .search-box { background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; padding: 5px; }
        .search-box input { flex: 1; border: none; outline: none; font-size: 16px; padding: 10px; }
        .suggestion-box { background: white; width: 100%; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 0 0 8px 8px; display: none; margin-top: 2px; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
        .suggestion-item:hover { background-color: #f5f5f5; }

        /* í•˜ë‹¨ + ë²„íŠ¼ */
        .add-btn {
            position: absolute; bottom: 30px; right: 20px; width: 60px; height: 60px;
            background: #ff4757; color: white; border-radius: 50%; font-size: 30px; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2000; cursor: pointer;
        }
        
        /* ìœ„ì¹˜ í™•ì • ë²„íŠ¼ (ì²˜ìŒì—” ìˆ¨ê¹€) */
        .confirm-container { display: none; position: absolute; bottom: 40px; left: 0; width: 100%; text-align: center; z-index: 2000; pointer-events: none; }
        .confirm-btn { background: #2ed573; color: white; padding: 12px 25px; border-radius: 30px; font-size: 16px; font-weight: bold; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; pointer-events: auto; }
        .cancel-btn-main { background: white; color: #555; border: none; padding: 12px 20px; border-radius: 30px; margin-left: 10px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; pointer-events: auto; }

        /* 3. ì…ë ¥ í¼ (ëª¨ë‹¬ì°½) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 85%; max-width: 320px; max-height: 90vh; overflow-y: auto; }
        
        input, select, textarea { width: 100%; box-sizing: border-box; margin: 8px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        /* ì‚¬ì§„ ì—…ë¡œë“œ ë²„íŠ¼ ë””ìì¸ */
        .file-label {
            display: block; padding: 15px; margin-top: 5px;
            border: 2px dashed #ddd; border-radius: 8px; text-align: center; color: #888; cursor: pointer; transition: 0.3s;
        }
        .file-label:hover { border-color: #ff4757; color: #ff4757; background: #fff0f1; }
        
        /* ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
        #preview_container { display: none; position: relative; margin-top: 10px; }
        #image_preview { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; }
        
        .save-btn { width: 100%; background: #ff4757; color: white; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .close-btn { width: 100%; background: transparent; color: #888; padding: 10px; border: none; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ğŸ“ ë¡œì¼€ì´ì…˜ ë¦¬ìŠ¤íŠ¸ (<span id="count">0</span>)</h2>
        </div>
        <div id="location_list">
            <div style="padding:20px; color:#999; text-align:center;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <div id="map">
        <div class="search-wrapper">
            <div class="search-box">
                <input type="text" id="search_input" placeholder="ğŸ” ì¥ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ì—­)" onkeyup="handleSearch(this.value)">
            </div>
            <div id="main_suggestions" class="suggestion-box"></div>
        </div>

        <button class="add-btn" id="addBtn" onclick="startAddMode()">+</button>

        <div class="confirm-container" id="confirmBtnContainer">
            <button class="confirm-btn" onclick="openForm()">ğŸ“ ì´ ìœ„ì¹˜ë¡œ ê²°ì •</button>
            <button class="cancel-btn-main" onclick="cancelAddMode()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; text-align:center;">ğŸ“ ë¡œì¼€ì´ì…˜ ë“±ë¡</h3>
            
            <input type="text" id="place_name" placeholder="ì¥ì†Œëª… (í•„ìˆ˜)">
            <select id="genre">
                <option value="ìŠ¤ë¦´ëŸ¬">ğŸ”´ ìŠ¤ë¦´ëŸ¬</option>
                <option value="ë¡œë§¨ìŠ¤">ğŸŸ¡ ë¡œë§¨ìŠ¤</option>
                <option value="ë“œë¼ë§ˆ">ğŸ”µ ë“œë¼ë§ˆ</option>
                <option value="ê³µí¬">âš« ê³µí¬</option>
                <option value="ì•¡ì…˜">ğŸŸ£ ì•¡ì…˜</option>
            </select>
            <input type="text" id="address_text" placeholder="ì£¼ì†Œ">
            <input type="text" id="comment" placeholder="í•œì¤„í‰ (íŠ¹ì´ì‚¬í•­)">

            <label for="file_input" class="file-label">ğŸ“¸ ì‚¬ì§„ ì¶”ê°€í•˜ê¸° (í´ë¦­)</label>
            <input type="file" id="file_input" accept="image/*" style="display:none" onchange="handleFileSelect(this)">
            
            <div id="preview_container">
                <img id="image_preview" src="">
                <p style="font-size:12px; color:#666; text-align:center; margin:5px 0;">*ì´ ì‚¬ì§„ì´ ë“±ë¡ë©ë‹ˆë‹¤</p>
            </div>

            <input type="hidden" id="lat"><input type="hidden" id="lng">
            
            <button class="save-btn" id="saveBtn" onclick="saveData()">ë“±ë¡í•˜ê¸°</button>
            <button class="close-btn" onclick="closeModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // â˜… ë‹˜ì˜ ì£¼ì†Œë¥¼ ì—¬ê¸° ë„£ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”! â˜…
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyEsgPRr5OqZdqkI30XbGh6zbs9iovR4XvHfPNOmwxvpzFoYLGGdorN2FPtAjAjJ27v2w/exec";

        // 1. ì§€ë„ ìƒì„± (ì„œìš¸ ì‹œì²­ ì¤‘ì‹¬)
        var map = L.map('map').setView([37.5665, 126.9780], 13);
        
        // 2. ë‹¤ì–‘í•œ ì§€ë„ ë ˆì´ì–´ ì¶”ê°€ (ì˜¤ë¥¸ìª½ ìœ„ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)
        var layers = {
            "ê¸°ë³¸ ì§€ë„": L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {maxZoom: 19}),
            "ë‹¤í¬ ëª¨ë“œ": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {maxZoom: 19}),
            "ìœ„ì„± ì§€ë„": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom: 18})
        };
        layers["ê¸°ë³¸ ì§€ë„"].addTo(map);
        L.control.layers(layers).addTo(map);

        var tempMarker = null; // ë‚´ê°€ ì°ì„ í•€
        var markers = []; // ë‚¨ë“¤ì´ ì°ì€ í•€ë“¤
        var uploadImageBase64 = ""; // ì‚¬ì§„ ë°ì´í„° ë‹´ì„ ë³€ìˆ˜

        // 3. ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° & ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°
        fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                var listEl = document.getElementById('location_list');
                listEl.innerHTML = ''; 
                document.getElementById('count').innerText = data.length;

                data.forEach(row => {
                    if(row.lat && row.lng) {
                        // 3-1. ì§€ë„ì— í•€ ì°ê¸°
                        var imgHtml = "";
                        // ì‚¬ì§„ì´ ìˆìœ¼ë©´ íŒì—…ì— ì´ë¯¸ì§€ íƒœê·¸ ì¶”ê°€
                        if(row['ì´ë¯¸ì§€'] && row['ì´ë¯¸ì§€'].startsWith("http")) {
                            imgHtml = `<img src="${row['ì´ë¯¸ì§€']}" class="popup-img" onclick="window.open('${row['ì´ë¯¸ì§€']}')">`;
                        }
                        
                        var marker = L.marker([row.lat, row.lng]).addTo(map);
                        marker.bindPopup(`<b>${row['ì¥ì†Œëª…']}</b><br>${row['í•œì¤„í‰']}${imgHtml}`);
                        markers.push(marker);

                        // 3-2. ì™¼ìª½ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°
                        var item = document.createElement('div');
                        item.className = 'location-item';
                        
                        // ì¸ë„¤ì¼ ì²˜ë¦¬
                        var thumbHtml = `<div class="thumb-box">No Img</div>`;
                        if(row['ì´ë¯¸ì§€'] && row['ì´ë¯¸ì§€'].startsWith("http")) {
                            thumbHtml = `<div class="thumb-box"><img src="${row['ì´ë¯¸ì§€']}"></div>`;
                        }

                        // ì¥ë¥´ íƒœê·¸ ìƒ‰ìƒ
                        var color = '#666';
                        if(row['ì¥ë¥´/ë¶„ìœ„ê¸°'] == 'ìŠ¤ë¦´ëŸ¬') color = '#ff4757';
                        else if(row['ì¥ë¥´/ë¶„ìœ„ê¸°'] == 'ë¡œë§¨ìŠ¤') color = '#ffa502';
                        else if(row['ì¥ë¥´/ë¶„ìœ„ê¸°'] == 'ë“œë¼ë§ˆ') color = '#1e90ff';

                        item.innerHTML = `
                            ${thumbHtml}
                            <div class="info-box">
                                <span class="genre-tag" style="background:${color}">${row['ì¥ë¥´/ë¶„ìœ„ê¸°']}</span>
                                <h3>${row['ì¥ì†Œëª…']}</h3>
                                <p>${row['ì£¼ì†Œ'] || 'ì£¼ì†Œ ë¯¸ì…ë ¥'}</p>
                            </div>
                        `;
                        
                        // ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ í•´ë‹¹ í•€ìœ¼ë¡œ ì´ë™
                        item.onclick = () => {
                            map.setView([row.lat, row.lng], 17);
                            marker.openPopup();
                        };
                        listEl.appendChild(item);
                    }
                });
            });

        // 4. ê²€ìƒ‰ ê¸°ëŠ¥ (ìë™ì™„ì„± & í•€ ì°ê¸° ì—°ê²°)
        var debounceTimer;
        function handleSearch(query) {
            clearTimeout(debounceTimer);
            var list = document.getElementById('main_suggestions');
            if(query.length < 2) { list.style.display = 'none'; return; }

            debounceTimer = setTimeout(() => {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&addressdetails=1`)
                    .then(res => res.json())
                    .then(data => {
                        list.innerHTML = '';
                        if(data.length > 0) {
                            list.style.display = 'block';
                            data.forEach(item => {
                                var div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.innerHTML = `<b>${item.display_name.split(',')[0]}</b><br><span style="color:#888;font-size:12px">${item.display_name}</span>`;
                                div.onclick = () => {
                                    var lat = item.lat; var lon = item.lon;
                                    map.setView([lat, lon], 17);
                                    
                                    // í•€ ì°ê¸° ëª¨ë“œ ì‹œì‘
                                    startAddMode([lat, lon]); 
                                    
                                    document.getElementById('search_input').value = item.display_name;
                                    document.getElementById('address_text').value = item.display_name; // ì£¼ì†Œ ë¯¸ë¦¬ ì…ë ¥
                                    list.style.display = 'none';
                                };
                                list.appendChild(div);
                            });
                        } else { list.style.display = 'none'; }
                    });
            }, 300);
        }

        // 5. ì‚¬ì§„ íŒŒì¼ ì„ íƒ & ì••ì¶• (í•µì‹¬ ê¸°ìˆ !)
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        // ìº”ë²„ìŠ¤ë¡œ ë¦¬ì‚¬ì´ì§• (ê°€ë¡œ 800pxë¡œ ì¤„ì—¬ì„œ ìš©ëŸ‰ ìµœì í™”)
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        var MAX_WIDTH = 800;
                        var width = img.width; var height = img.height;
                        
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ì••ì¶•ëœ ë°ì´í„° (JPEG í€„ë¦¬í‹° 0.7)
                        var dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        
                        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                        document.getElementById('image_preview').src = dataUrl;
                        document.getElementById('preview_container').style.display = 'block';
                        
                        // ì „ì†¡ìš© ë°ì´í„° (ì•ì— 'data:image...' ë–¼ê³  ë‚´ìš©ë§Œ ë‹´ê¸°)
                        uploadImageBase64 = dataUrl.split(',')[1];
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 6. ë°ì´í„° ì €ì¥ (ì‚¬ì§„ í¬í•¨ ì „ì†¡)
        function saveData() {
            var name = document.getElementById('place_name').value;
            var genre = document.getElementById('genre').value;
            var addr = document.getElementById('address_text').value;
            var comment = document.getElementById('comment').value;
            var lat = document.getElementById('lat').value;
            var lng = document.getElementById('lng').value;

            if(!name) { alert("ì¥ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

            var btn = document.getElementById('saveBtn');
            btn.innerText = "ì €ì¥ ì¤‘... (ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘)";
            btn.disabled = true;

            // ì „ì†¡í•  ë°ì´í„° í¬ì¥
            var payload = new URLSearchParams();
            payload.append('place_name', name);
            payload.append('genre', genre);
            payload.append('address', addr);
            payload.append('lat', lat);
            payload.append('lng', lng);
            payload.append('comment', comment);
            
            // ì‚¬ì§„ì´ ìˆìœ¼ë©´ ê°™ì´ ë„£ê¸°
            if(uploadImageBase64) {
                payload.append('image_data', uploadImageBase64);
                payload.append('image_mime', 'image/jpeg');
            }

            // ì„œë²„ë¡œ ë°œì‚¬!
            fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: payload
            })
            .then(() => {
                alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                location.reload(); 
            })
            .catch(err => {
                alert("ì—ëŸ¬: " + err);
                btn.innerText = "ë“±ë¡í•˜ê¸°";
                btn.disabled = false;
            });
        }

        // --- ê¸°íƒ€ UI í•¨ìˆ˜ë“¤ ---
        function startAddMode(coords) {
            var center = coords ? coords : map.getCenter();
            if(tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker(center, {draggable: true}).addTo(map);
            tempMarker.bindPopup("ìœ„ì¹˜ë¥¼ ì¡ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”").openPopup();
            
            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('confirmBtnContainer').style.display = 'block';
        }
        function cancelAddMode() {
            if(tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
            document.getElementById('addBtn').style.display = 'flex';
            document.getElementById('confirmBtnContainer').style.display = 'none';
        }
        function openForm() {
            if(!tempMarker) return;
            var c = tempMarker.getLatLng();
            document.getElementById('lat').value = c.lat; document.getElementById('lng').value = c.lng;
            document.getElementById('modal').style.display = 'flex';
        }
        function closeModal() { 
            document.getElementById('modal').style.display = 'none'; 
            document.getElementById('file_input').value = ""; // íŒŒì¼ ì´ˆê¸°í™”
            document.getElementById('preview_container').style.display = 'none';
            uploadImageBase64 = "";
        }
        window.onclick = function(e) { 
            if(e.target == document.getElementById('modal')) closeModal(); 
            if (!e.target.closest('.search-wrapper')) document.getElementById('main_suggestions').style.display = 'none';
        }
    </script>
</body>
</html>